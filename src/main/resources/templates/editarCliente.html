<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Editar cliente</title>
    <link rel="icon" th:href="@{/img/favicon.ico}">
    <link rel="stylesheet" th:href="@{/css/registroAdmin.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="registro-container">

    <a th:href="@{/admin/usuarios}" class="back-arrow">←</a>

    <h2>Editar cliente</h2>

    <form id="editarForm" th:action="@{'/admin/usuarios/clientes/editar/' + ${clienteForm.idCliente}}"
          th:object="${clienteForm}" method="post">

        <div class="field">
            <label for="nombre">Nombre</label>
            <input id="nombre" type="text" th:field="*{usuario.nombre}"
                   placeholder="Nombre" maxlength="20">
        </div>

        <div class="field">
            <label for="apellidos">Apellidos</label>
            <input id="apellidos" type="text" th:field="*{usuario.apellidos}"
                   placeholder="Apellidos" maxlength="50">
            <div class="error" id="apellidosError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="email">Correo electrónico</label>
            <input id="email" type="email" th:field="*{usuario.email}"
                   placeholder="ejemplo@correo.com" maxlength="100">
            <div class="error" id="emailError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="telefono">Teléfono</label>
            <input id="telefono" type="tel" th:field="*{usuario.telefono}"
                   placeholder="9 dígitos" pattern="\d{9}" maxlength="9">
            <div class="error" id="telefonoError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="contrasenia">Contraseña</label>
            <input type="password" id="contrasenia" name="contrasenia"
                   placeholder="Dejar vacío para mantener actual" maxlength="20">
            <div class="error" id="contraseniaError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="contrasenia2">Confirmar contraseña</label>
            <input type="password" id="contrasenia2" name="confirmContrasenia"
                   placeholder="Repite la contraseña" maxlength="20">
            <div class="error" id="contrasenia2Error" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="fechaNacimiento">Fecha de nacimiento</label>
            <input id="fechaNacimiento" type="date" th:field="*{fechaNacimiento}">
            <div class="error" id="fechaError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="genero">Género</label>
            <select id="genero" th:field="*{genero}">
                <option value="">Selecciona un género</option>
                <option th:each="g : ${T(es.unex.mdai.FitReserve.data.enume.Genero).values()}"
                        th:value="${g}"
                        th:text="${g}">
                </option>
            </select>
            <div class="error" id="generoError" aria-live="polite"></div>
        </div>

        <div class="field">
            <label for="objetivos">Objetivos</label>
            <textarea id="objetivos" th:field="*{objetivos}"
                      placeholder="Objetivos del cliente" maxlength="255"></textarea>
            <div class="error" id="objetivosError" aria-live="polite"></div>
        </div>

        <!-- Zona de alertas -->
        <div class="alert-container">
            <div th:if="${mensajeExito}" class="alert alert-success" role="alert">
                <span th:text="${mensajeExito}">Mensaje de éxito</span>
            </div>
            <div th:if="${mensajeError}" class="alert alert-error" role="alert">
                <span th:text="${mensajeError}">Mensaje de error</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn" type="submit">Guardar cambios</button>
        </div>
    </form>

</div>

<script>
    (function () {
        const form = document.getElementById('editarForm');
        const contrasenia = document.getElementById('contrasenia');
        const contrasenia2 = document.getElementById('contrasenia2');
        const fechaNacimiento = document.getElementById('fechaNacimiento');

        function showError(input, errorId, message) {
            const errorDiv = document.getElementById(errorId);
            if (errorDiv) errorDiv.textContent = message;
        }

        function clearError(errorId) {
            const errorDiv = document.getElementById(errorId);
            if (errorDiv) errorDiv.textContent = '';
        }

        function clearAllErrors() {
            ['contrasenia2Error', 'fechaError'].forEach(id => clearError(id));
        }

        function passwordsMatch() {
            const v1 = contrasenia.value.trim();
            const v2 = contrasenia2.value.trim();

            if (v1 === '' && v2 === '') {
                return true;
            }

            return v1 === v2;
        }

        if (form) {
            form.addEventListener('submit', function (e) {
                clearAllErrors();
                let hasError = false;

                const nuevaPass = contrasenia.value.trim();
                const confirm = contrasenia2.value.trim();

                if (nuevaPass !== '' || confirm !== '') {
                    if (!passwordsMatch()) {
                        showError(contrasenia2, 'contrasenia2Error', 'Las contraseñas no coinciden.');
                        hasError = true;
                    }
                }

                if (fechaNacimiento.value) {
                    const fecha = new Date(fechaNacimiento.value);
                    const hoy = new Date();
                    if (fecha > hoy) {
                        showError(fechaNacimiento, 'fechaError', 'La fecha de nacimiento no puede ser futura.');
                        hasError = true;
                    }
                }

                if (hasError) {
                    e.preventDefault();
                }
            });
        }

        // Validación en tiempo real de contraseñas
        if (contrasenia) contrasenia.addEventListener('input', function () {
            if (contrasenia2.value.trim()) {
                if (!passwordsMatch()) showError(contrasenia2, 'contrasenia2Error', 'Las contraseñas no coinciden.');
                else clearError('contrasenia2Error');
            }
        });

        if (contrasenia2) contrasenia2.addEventListener('input', function () {
            if (contrasenia.value.trim() || contrasenia2.value.trim()) {
                if (!passwordsMatch()) showError(contrasenia2, 'contrasenia2Error', 'Las contraseñas no coinciden.');
                else clearError('contrasenia2Error');
            }
        });

        // Validación en tiempo real de fecha
        if (fechaNacimiento) fechaNacimiento.addEventListener('change', function () {
            if (fechaNacimiento.value) {
                const fecha = new Date(fechaNacimiento.value);
                const hoy = new Date();
                if (fecha > hoy) {
                    showError(fechaNacimiento, 'fechaError', 'La fecha de nacimiento no puede ser futura.');
                } else {
                    clearError('fechaError');
                }
            }
        });
    })();
</script>
</body>
</html>